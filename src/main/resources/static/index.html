<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Recall Royale</title>
    <style>
        body { margin:0; font-family: system-ui, Arial; background:#0f1220; color:#fff; }
        .wrap { position:relative; min-height:100vh; display:flex; align-items:center; justify-content:center; }

        /* corners */
        .corner { position:absolute; padding:12px 16px; background:#1b2140; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.3); }
        .tl { top:12px; left:12px; }
        .tr { top:12px; right:12px; }
        .bl { bottom:12px; left:12px; }
        .br { bottom:12px; right:12px; }

        /* board */
        #board { display:grid; gap:10px; align-content:center; justify-content:center; }
        .cell {
          width:72px; height:72px; border:0; border-radius:10px; cursor:pointer;
          background:#2b3566; color:#fff; font-weight:700; font-size:22px;
          display:flex; align-items:center; justify-content:center;
          transition:transform .12s ease, background .2s ease; user-select:none;
        }
        .cell.faceup { background:#00a3ff; transform:scale(1.03); }
        .cell.matched { background:#21c55d; transform:scale(1.05); }
        .cell.block { background:#444; color:#bbb; cursor:not-allowed; }

        /* top controls */
        .controls { position:absolute; top:50%; transform:translateY(-50%); left:12px; width:260px; }
        .controls .card { background:#151b36; border-radius:12px; padding:12px; margin-bottom:10px; }
        input, select, button { width:100%; padding:8px 10px; margin:6px 0; border-radius:8px; border:0; }
        button { background:#5865f2; color:#fff; font-weight:700; cursor:pointer; }
        button:disabled { background:#3942a6; cursor:not-allowed; }

        .turn { text-align:center; margin-bottom:10px; font-size:18px; }
        .winner { font-size:22px; text-align:center; margin-top:8px; color:#ffe38f; }
    </style>
</head>
<body>
<div class="wrap">

    <!-- corners -->
    <div class="corner tl" id="p0">P1: -</div>
    <div class="corner tr" id="p1">P2: -</div>
    <div class="corner bl" id="p2">P3: -</div>
    <div class="corner br" id="p3">P4: -</div>

    <!-- center board -->
    <div>
        <div class="turn" id="turnTxt">Welcome to Recall Royale</div>
        <div id="board"></div>
        <div class="winner" id="winner"></div>
    </div>

    <!-- left control panel -->
    <div class="controls">
        <div class="card">
            <strong>Setup</strong>
            <select id="sizeSel">
                <option value="6">6 Ã— 6 (Easy)</option>
                <option value="9">9 Ã— 9 (Hard)</option>
            </select>
            <select id="modeSel">
                <option value="LETTERS">Letters</option>
                <option value="IMAGES">Images (IDs)</option>
            </select>
            <button onclick="createGame()">Create Game</button>
            <button onclick="start()" id="startBtn" disabled>Start</button>
        </div>

        <div class="card">
            <strong>Players</strong>
            <input id="n1" placeholder="Player 1 name"/>
            <input id="n2" placeholder="Player 2 name"/>
            <input id="n3" placeholder="Player 3 name"/>
            <input id="n4" placeholder="Player 4 name"/>
            <button onclick="joinAll()">Add Players</button>
        </div>
    </div>

</div>

<script>
    const API = '/api/game';
    let rows = 6, cols = 6;

    async function createGame() {
      rows = parseInt(document.getElementById('sizeSel').value, 10);
      cols = rows; // square board
      const mode = document.getElementById('modeSel').value;

      await fetch(API + '/create', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ rows, cols, mode })
      });
      document.getElementById('startBtn').disabled = false;
      refresh();
    }

    async function joinAll() {
      const names = ['n1','n2','n3','n4'].map(id => document.getElementById(id).value.trim()).filter(x => x.length>0);
      for (const nm of names) {
        await fetch(API + '/join', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:nm}) });
      }
      refresh();
    }

    async function start() {
      await fetch(API + '/start', { method:'POST' });
      refresh();
    }

    function gridCss(n){ return `repeat(${n}, 72px)`; }

    async function refresh() {
      const res = await fetch(API + '/state');
      const state = await res.json();

      // corners: up to 4 players
      for (let i=0; i<4; i++) {
        const el = document.getElementById('p'+i);
        if (state.players[i]) el.textContent = `${state.players[i].name}: ${state.players[i].score}`;
        else el.textContent = `P${i+1}: -`;
      }

      // turn text / winner
      const turn = document.getElementById('turnTxt');
      const winner = document.getElementById('winner');
      winner.textContent = '';
      if (state.status === 'RUNNING') {
        const p = state.players[state.currentPlayerIdx];
        turn.textContent = `Turn: ${p ? p.name : 'â€”'}`;
      } else if (state.status === 'FINISHED') {
        const best = [...state.players].sort((a,b)=>b.score-a.score)[0];
        turn.textContent = 'Game Over';
        winner.textContent = `ðŸ† Winner: ${best.name} with ${best.score} point(s)!`;
      } else {
        turn.textContent = 'Lobby: create game, add players, then Start.';
      }

      // board
      rows = state.rows; cols = state.cols;
      const board = document.getElementById('board');
      board.style.gridTemplateColumns = gridCss(cols);
      board.innerHTML = '';
      state.tiles.forEach(t => {
        const btn = document.createElement('button');
        btn.className = 'cell';
        if (t.blocked) btn.classList.add('block');
        if (t.faceUp) btn.classList.add('faceup');
        if (t.matched) btn.classList.add('matched');

        btn.textContent = (t.faceUp || t.matched) ? (t.blocked ? 'â– ' : t.key) : '';
        btn.onclick = ()=> flip(t.index);
        board.appendChild(btn);
      });
    }

    async function flip(idx) {
      const res = await fetch(API + '/flip', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ index: idx })
      });
      const data = await res.json();
      await refresh();

      // if mismatch, show the two for 800ms then hide on server
      if (data.action === 'MISMATCH') {
        await new Promise(r => setTimeout(r, 800));
        await fetch(API + '/hidePending', { method:'POST' });
        await refresh();
      }
    }

    // boot
    refresh();
</script>
</body>
</html>
